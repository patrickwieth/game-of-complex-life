<html>
<head>
    <title>Game of Life</title>
    <style>
        body{
            width:1200px;
            margin:0 auto;
        }
        rect{
            stroke:rgba(204, 204,204,0.2);
            shape-rendering:crispEdges;
        }
        .edit:hover{
            stroke:steelblue;
            cursor:pointer;
        }
        select{
            width:80px;
        }
        button{
            min-width:50px;
            padding: 0 40px;
        }
    /*
        path {
            transition: fill 1s ease;
        }
    */
    </style>
</head>
<body>
    Set nothing here: <select onchange="changeUniv(this)"></select>
    <input type="string" onchange="setDecisionFunction(this)" value='function() { return { action: "move", value: 1 }; }'/>
    <button type="button" onClick="newUniv()">New</button>
    <button type="button" onClick="startUniv()" id='startBtn'>Stop</button>
</section>
<svg width='1600' height='1000'></svg>

<script src="/socket.io/socket.io.js"></script>
<!--script src="http://d3js.org/d3.v3.min.js"></script-->
<script src="/d3.v3.min.js"></script>

<script src="goL.js"></script>



<script>
    var name = "none";
    var newName = "none";

    function setDecisionFunction(fn) {
        fn.value = "("+fn.value+")";

        console.log("fn:", fn);

        try{
            var decisionFunction = eval(fn.value);
        }
        catch(bla) {
            console.log(bla);
        }


        // here a check should be run
        var testCell = {state: {
            color: "green",
            energy: 2,
            species: "test"
            },
            neighbors: [
                {state: {
                    color: "green",
                    energy: 2,
                    species: "test"}
                },
                {state: {
                    color: "blue",
                    energy: 2,
                    species: "test2"}
                },
                {state: {
                    color: "white",
                    energy: 0,
                    species: "empty"}
                },
                {state: {
                    color: "white",
                    energy: 0,
                    species: "empty"}
                },
                {state: {
                    color: "brown",
                    energy: 2,
                    species: "wall"}
                },
                {state: {
                    color: "purple",
                    energy: 1,
                    species: "test3"}
                }
            ]
        };

        var testResult = decisionFunction(testCell);

        if(typeof testResult === 'object' && testResult.action && testResult.value) {
            goL.decisionFunction = decisionFunction;
            console.log("new decision function set");
        }
        else console.log("failed to set decision function");
    }

    function setName(string) {

        newName = string.value;
        /*socket.send({
            type: "setParameters",
            huntRate: name
        });*/
    }

    function newUniv(){
        console.log("newUniv()");

        socket.send("reset");
    }

    function startUniv(){
        console.log("startUniv()");

        if(d3.select("#startBtn").html()=="Start"){
            d3.select("#startBtn").html("Pause");
            socket.send("start");
        }
        else{
            d3.select("#startBtn").html("Start");
            socket.send("stop");
        }
    }

    var socket = io.connect();

    // get registered
    var myKey;
    socket.on('message', function (event) {
        if(typeof event === 'object') {
            if (typeof event.key === 'string') {
                myKey = event.key;
                console.log(myKey);
            }
        }
    });

    // state of the game updates
    socket.on('state', function (data) {
        goL.setGrid(data);

        var decisions = goL.makeDecisions();
        socket.send({ type: "decisions", key: myKey, value: decisions });
    });

</script>